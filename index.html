<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIRINEO TV - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: white; overflow: hidden; }
        /* Animación para nota entrante */
        .note-overlay { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // TU CONFIGURACIÓN FIREBASE (La misma de tu app principal)
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const Icon = ({ name, size = 24, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        const TVDashboard = () => {
            const [orders, setOrders] = useState([]);
            const [currentNote, setCurrentNote] = useState(null);
            const [audioQueue, setAudioQueue] = useState([]);
            const [isAudioReady, setIsAudioReady] = useState(false);
            const audioRef = useRef(new Audio());

            // 1. Cargar Órdenes
            useEffect(() => {
                const unsub = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    setOrders(data);
                });
                return () => unsub();
            }, []);

            // 2. Escuchar Mensajes (Notas y Audios)
            useEffect(() => {
                const unsub = db.collection('tv_messages').onSnapshot(async (snap) => {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const msg = { id: change.doc.id, ...change.doc.data() };
                            
                            // Si es TEXTO, mostrar en pantalla
                            if (msg.type === 'text') {
                                if (msg.action === 'clear') setCurrentNote(null);
                                else setCurrentNote(msg.content);
                                // Borrar comando de la DB inmediatamente para limpieza
                                if(msg.action === 'clear') db.collection('tv_messages').doc(msg.id).delete();
                            }
                            
                            // Si es AUDIO, agregar a la cola
                            if (msg.type === 'audio') {
                                setAudioQueue(prev => [...prev, msg]);
                            }
                        }
                    });
                });
                return () => unsub();
            }, []);

            // 3. Procesar Cola de Audio
            useEffect(() => {
                if (audioQueue.length > 0 && isAudioReady && audioRef.current.paused) {
                    const nextMsg = audioQueue[0];
                    const playAudio = async () => {
                        try {
                            audioRef.current.src = nextMsg.content; // Base64 audio
                            await audioRef.current.play();
                            
                            // Cuando termine, borrar de DB y quitar de cola local
                            audioRef.current.onended = async () => {
                                await db.collection('tv_messages').doc(nextMsg.id).delete();
                                setAudioQueue(prev => prev.slice(1));
                            };
                        } catch (e) {
                            console.error("Error reproduciendo audio", e);
                            // Si falla, borrarlo igual para no atascar
                            await db.collection('tv_messages').doc(nextMsg.id).delete();
                            setAudioQueue(prev => prev.slice(1));
                        }
                    };
                    playAudio();
                }
            }, [audioQueue, isAudioReady]);

            useEffect(()=>lucide.createIcons(), [orders, currentNote]);

            // --- LÓGICA DE DATOS ---
            const machines = useMemo(() => {
                const groups = {};
                orders.forEach(o => {
                    if (!groups[o.maquina]) groups[o.maquina] = { 
                        id: o.maquina, 
                        totalTarget: 0, 
                        totalDone: 0,
                        orders: []
                    };
                    
                    // Contar producción
                    const done = o.progreso.filter(p => p.finished).reduce((acc, curr) => acc + (curr.cantidad || 0), 0);
                    const total = o.progreso.reduce((acc, curr) => acc + (curr.cantidad || 0), 0);
                    
                    groups[o.maquina].totalDone += done;
                    groups[o.maquina].totalTarget += total;
                    groups[o.maquina].orders.push(o);
                });
                
                // Solo máquinas con órdenes activas
                return Object.values(groups).sort((a,b) => parseInt(a.id) - parseInt(b.id));
            }, [orders]);

            if (!isAudioReady) {
                return (
                    <div onClick={() => setIsAudioReady(true)} className="h-screen w-full flex flex-col items-center justify-center bg-blue-900 text-white cursor-pointer">
                        <Icon name="tv" size={64} className="mb-4 animate-bounce"/>
                        <h1 className="text-4xl font-bold">TOCA LA PANTALLA PARA INICIAR TV</h1>
                        <p className="mt-2 text-blue-200">Necesario para habilitar audio</p>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col bg-slate-900">
                    {/* --- MITAD ARRIBA: PRODUCCIÓN --- */}
                    <div className="h-1/2 border-b-4 border-slate-700 p-4 bg-slate-800 overflow-hidden">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-2xl font-black text-yellow-400 flex gap-2 items-center"><Icon name="bar-chart-2"/> PRODUCCIÓN EN TIEMPO REAL</h2>
                            <div className="text-xl font-bold text-slate-400">{new Date().toLocaleTimeString()}</div>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-4 h-full content-start">
                            {machines.map(m => {
                                const percentage = m.totalTarget > 0 ? Math.round((m.totalDone / m.totalTarget) * 100) : 0;
                                return (
                                    <div key={m.id} className="bg-slate-700 rounded-lg p-4 flex flex-col items-center shadow-lg border border-slate-600 relative overflow-hidden">
                                        <div className="absolute inset-0 bg-green-600 opacity-20" style={{top: `${100 - percentage}%`}}></div>
                                        <div className="text-4xl font-black text-white z-10">MQ {m.id}</div>
                                        <div className="text-6xl font-black text-green-400 z-10 my-2">{m.totalDone}</div>
                                        <div className="text-sm font-bold text-slate-400 z-10 uppercase">de {m.totalTarget} Piezas</div>
                                        <div className="text-xs bg-black px-2 py-1 rounded mt-2 z-10 font-mono text-yellow-500">{percentage}% COMPLETADO</div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* --- MITAD ABAJO: PENDIENTES --- */}
                    <div className="h-1/2 bg-slate-900 p-4 overflow-x-auto whitespace-nowrap">
                         <h2 className="text-xl font-black text-slate-500 mb-2 flex gap-2 items-center sticky left-0"><Icon name="list"/> COLAS DE TRABAJO (PENDIENTES)</h2>
                         <div className="flex gap-4 h-full pb-4">
                            {machines.map(m => (
                                <div key={m.id} className="w-80 bg-slate-800 rounded border border-slate-700 flex flex-col h-full shrink-0">
                                    <div className="bg-slate-950 p-2 font-bold text-center border-b border-slate-700">MÁQUINA {m.id}</div>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                        {m.orders.map(order => {
                                            const pendingPkgs = order.progreso.filter(p => !p.finished);
                                            if(pendingPkgs.length === 0) return null;
                                            return (
                                                <div key={order.id} className="bg-slate-700 p-2 rounded text-sm border-l-4 border-yellow-500">
                                                    <div className="flex justify-between font-bold text-slate-300">
                                                        <span>{order.codigo}</span>
                                                        <span className="text-[10px] bg-slate-900 px-1 rounded">{order.partida}</span>
                                                    </div>
                                                    <div className="mt-1 space-y-1">
                                                        {pendingPkgs.slice(0, 3).map((p, idx) => (
                                                            <div key={idx} className="flex justify-between bg-slate-800 px-2 py-1 rounded text-xs">
                                                                <span className="text-white font-bold">{p.cantidad} pzs</span>
                                                                <span className="text-slate-400 truncate w-24 text-right">{p.piezaNombre}</span>
                                                            </div>
                                                        ))}
                                                        {pendingPkgs.length > 3 && <div className="text-center text-[10px] text-slate-500">...y {pendingPkgs.length - 3} paquetes más</div>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                         </div>
                    </div>

                    {/* --- CAPA DE NOTAS --- */}
                    {currentNote && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-10 note-overlay">
                            <div className="text-center">
                                <Icon name="bell" size={80} className="text-yellow-500 mx-auto mb-6 animate-pulse"/>
                                <h1 className="text-6xl md:text-8xl font-black text-white leading-tight uppercase drop-shadow-lg text-wrap break-words">
                                    {currentNote}
                                </h1>
                                <p className="text-slate-400 mt-10 text-2xl animate-pulse">Mensaje del Supervisor</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TVDashboard />);
    </script>
</body>
</html>
