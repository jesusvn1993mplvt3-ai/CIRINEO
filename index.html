<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Producción de Tejido</title>
    <!-- Tailwind CSS CDN para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuentes Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos personalizados para la barra de desplazamiento */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background-color: #1e293b; /* Debe coincidir con el fondo de la fila */
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    
    <!-- CDNs de Librerías Requeridas -->
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Exponer las funciones y objetos necesarios al ámbito global
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc 
        };
        // Iniciar la aplicación después de cargar Firebase (ver script principal)
    </script>
    
    <!-- Chart.js (Gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- jsPDF y AutoTable (PDFs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-900 text-slate-100 p-4 min-h-screen">

    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- El contenido se inyectará aquí -->
        <div id="loading-screen" class="flex items-center justify-center h-screen">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-xl text-indigo-400">Cargando aplicación y autenticación...</span>
        </div>
    </div>
    
    <!-- Contenedor para Modales -->
    <div id="modal-root"></div>

    <script>
        // =================================================================
        //                 CONSTANTES Y CONFIGURACIÓN INICIAL
        // =================================================================

        // Globales de Firebase (inyectadas por el entorno de Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Rutas de Firestore
        const FIREBASE_COLLECTION = 'production_data';
        const VISIBILITY_DOC_PATH = `/artifacts/${appId}/public/data/config/visibilityConfig`;
        const getPrivateDocPath = (uid) => `/artifacts/${appId}/users/${uid}/${FIREBASE_COLLECTION}`;

        // Definiciones
        const ROLES = {
            ADMIN: 'Admin', OPERATOR: 'Operador', DEVELOPMENT: 'Desarrollo',
            COMMENTATOR: 'Comentador', OBSERVER: 'Observador'
        };

        const USERS = {
            '1111': { name: 'Marco Espinoza', role: ROLES.ADMIN, area: 'Administración' },
            '0000': { name: 'Prisciliano Espinoza', role: ROLES.COMMENTATOR, area: 'Comentarios' },
            '2222': { name: 'Susana', role: ROLES.OBSERVER, area: 'Observación' },
            '1352': { name: 'Vallejo', role: ROLES.DEVELOPMENT, area: 'Desarrollo' },
            '3333': { name: 'Tejido', role: ROLES.OPERATOR, area: 'Operadores Gral' },
            // IDs de los operadores clave para la lógica de asignación
            '7914': { name: 'Balta', role: ROLES.OPERATOR, area: 'Tejido (B)', allowedSlots: [0, 1] },
            '1392': { name: 'Andrés', role: ROLES.OPERATOR, area: 'Tejido (A)', allowedSlots: [2, 3] }
        };

        const MONTH_NAMES_ES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        const MACHINE_CONFIG = [
            { id: 'MAQ 35', name: 'MAQ 35' }, { id: 'MAQ 39', name: 'MAQ 39' }, { id: 'MAQ 40', name: 'MAQ 40' },
            { id: 'MAQ 36', name: 'MAQ 36' }, { id: 'MAQ 38', name: 'MAQ 38' }, { id: 'MAQ 37', name: 'MAQ 37' },
            { id: 'MAQ 29', name: 'MAQ 29' }, { id: 'MAQ 28', name: 'MAQ 28' }, { id: 'MAQ 1', name: 'MAQ 1' },
            { id: 'MAQ 27', name: 'MAQ 27' }, { id: 'MAQ 30', name: 'MAQ 30' }, { id: 'MAQ 31', name: 'MAQ 31' },
            { id: 'MAQ 6', name: 'MAQ 6' }, { id: 'MAQ 5', name: 'MAQ 5' }, { id: 'MAQ 32', name: 'MAQ 32' },
            { id: 'MAQ 33', name: 'MAQ 33' }, { id: 'MAQ 34', name: 'MAQ 34' }, { id: 'MAQ 4', name: 'MAQ 4' }
        ];

        // =================================================================
        //                      VARIABLES DE ESTADO (Globales)
        // =================================================================

        let db = null;
        let auth = null;
        let userId = null;
        let operatorName = 'Cargando...';
        let authReady = false;
        let currentMonthDate = new Date();
        let monthData = {};
        let visibilityConfig = null;
        let currentMonthDataUnsubscribe = null;
        let visibilityConfigUnsubscribe = null;

        // =================================================================
        //                          UTILIDADES
        // =================================================================

        const getDateKey = (date) => date.toISOString().split('T')[0];
        const getMonthKey = (date) => `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

        const getDaysInMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const numDays = new Date(year, month + 1, 0).getDate();
            const days = [];
            for (let i = 1; i <= numDays; i++) {
                days.push(new Date(year, month, i));
            }
            return days;
        };

        const canEditSlot = (checkUserId, machineId, slotIndex, config) => {
            const user = USERS[checkUserId];
            if (!user) return false;

            // 1. Rol Desarrollo tiene permiso total.
            if (user.role === ROLES.DEVELOPMENT) return true;

            // 2. Operadores pueden editar solo si la máquina está visible (implícito en la tabla)
            // Y si el slot tiene el ID del usuario asignado en la BD (configuración del DEV).
            if (user.role === ROLES.OPERATOR) {
                const machineConfig = config?.slots?.[machineId];
                const assignedUserId = machineConfig?.permissions?.[slotIndex];
                
                // Si el slot está asignado al ID del usuario actual, puede editarlo.
                return assignedUserId === checkUserId; 
            }
            
            return false;
        };

        // =================================================================
        //                      MANEJO DE DATOS FIREBASE
        // =================================================================

        const setupFirebase = () => {
            if (!window.firebase) {
                console.error("Firebase no ha cargado correctamente.");
                return;
            }
            
            const { initializeApp, getAuth, getFirestore } = window.firebase;
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Inicializar Autenticación
            setupAuthListener();
        };

        const setupAuthListener = () => {
            const { onAuthStateChanged, signInWithCustomToken, signInAnonymously } = window.firebase;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    operatorName = USERS[userId]?.name || 'Usuario Desconocido';
                } else {
                    // Si no está autenticado, intentar firmar de nuevo
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                         // Si la firma anónima falla, asignamos un ID de invitado.
                        userId = 'GUEST_' + crypto.randomUUID().substring(0, 8);
                        operatorName = 'Invitado';
                        console.warn("Fallo en la autenticación anónima o con token. Usando ID de Invitado.");
                    }
                }
                
                authReady = true;
                // Una vez autenticado (o con ID de invitado), iniciar suscripciones
                setupDataSubscriptions();
                renderApp();
            });
        };
        
        const setupDataSubscriptions = () => {
            const { doc, onSnapshot } = window.firebase;
            
            // A. Suscripción a Configuración de Visibilidad (Pública)
            if (visibilityConfigUnsubscribe) visibilityConfigUnsubscribe();
            const visibilityRef = doc(db, VISIBILITY_DOC_PATH);
            visibilityConfigUnsubscribe = onSnapshot(visibilityRef, (docSnap) => {
                if (docSnap.exists()) {
                    visibilityConfig = docSnap.data();
                } else {
                    visibilityConfig = { machineOrder: MACHINE_CONFIG.map(m => m.id), slots: {} };
                }
                renderApp();
            }, (error) => {
                console.error("Error al suscribirse a visibilityConfig:", error);
            });
            
            // B. Suscripción a Datos del Mes Actual (Privada del Usuario)
            if (currentMonthDataUnsubscribe) currentMonthDataUnsubscribe();
            if (userId === 'GUEST') return; // Invitados no leen datos privados

            const monthKey = getMonthKey(currentMonthDate);
            const monthDocRef = doc(db, getPrivateDocPath(userId), monthKey);
            
            currentMonthDataUnsubscribe = onSnapshot(monthDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    monthData = docSnap.data().data || {};
                } else {
                    monthData = {};
                }
                renderApp();
            }, (error) => {
                console.error(`Error al suscribirse a los datos del mes (${monthKey}):`, error);
            });
        };

        // =================================================================
        //                       LÓGICA DE RENDERIZADO
        // =================================================================

        const renderCell = (day, machineId) => {
            const dateKey = getDateKey(day);
            const dayData = monthData[dateKey] || {};
            const machineData = dayData[machineId] || {};
            const slots = machineData.slots || [];
            
            // Obtener la configuración de slots para esta máquina (devuelve 2, 3 o 4)
            const slotCount = visibilityConfig?.slots?.[machineId]?.count || 2;
            const slotsToShow = slots.slice(0, slotCount);

            // Determinar qué slots específicos puede editar el usuario
            const editableSlots = slotsToShow.map((_, index) => 
                canEditSlot(userId, machineId, index, visibilityConfig)
            );
            
            const canUserEditAnySlot = editableSlots.some(isEditable => isEditable);
            
            const totalQty = slotsToShow.reduce((acc, slot) => acc + (Number(slot?.qty) || 0), 0);

            const cellClass = canUserEditAnySlot 
                ? 'cursor-pointer hover:bg-slate-700/50 transition-colors' 
                : 'opacity-50';

            // Generar los elementos visuales de los slots (ej: 0 | 0 | 0 | 0)
            const slotDisplay = slotsToShow.map((slot, index) => {
                const isBaltaSlot = index === 0 || index === 1; // Slots 0 y 1 históricamente para Balta
                const colorClass = isBaltaSlot ? 'text-pink-400' : 'text-indigo-400';
                const fontClass = editableSlots[index] ? 'font-bold' : 'font-light';
                
                return `<span class="${colorClass} ${fontClass}">${Number(slot?.qty) || 0}</span>`;
            }).join('<span class="text-slate-600"> / </span>');


            return `
                <td 
                    id="cell-${dateKey}-${machineId}"
                    class="min-w-[150px] w-[150px] text-center border-r border-slate-700 last:border-r-0 p-1 relative ${cellClass}"
                    data-date-key="${dateKey}"
                    data-machine-id="${machineId}"
                    onclick="showCellEditor('${dateKey}', '${machineId}')"
                >
                    <div class="flex flex-col justify-center h-full">
                        <span class="text-xl font-black text-white leading-none">${totalQty}</span>
                        <span class="text-[9px] text-slate-400">PZAS TOTALES</span>
                        
                        <div class="mt-1 flex justify-center text-[10px] font-mono gap-1">
                            ${slotDisplay}
                        </div>
                        
                        ${machineData.calculated_target > 0 ? `
                            <div class="mt-1 text-[8px] text-slate-500">
                                Meta: <span class="text-yellow-400 font-bold">${machineData.calculated_target}</span>
                            </div>
                        ` : ''}
                    </div>
                </td>
            `;
        };

        const renderTable = () => {
            const daysInMonth = getDaysInMonth(currentMonthDate);
            
            const machineMap = new Map(MACHINE_CONFIG.map(m => [m.id, m]));
            const machineOrder = visibilityConfig?.machineOrder || MACHINE_CONFIG.map(m => m.id);
            const visibleMachines = machineOrder.map(id => machineMap.get(id)).filter(m => m);

            let tableHTML = `
                <table class="min-w-full table-fixed bg-slate-800 border-collapse">
                    <thead>
                        <tr class="bg-slate-700 sticky top-0 z-20 shadow-md">
                            <th class="w-20 text-xs font-bold text-slate-300 border-r border-slate-600 p-3 sticky-col bg-slate-700">Día</th>
                            ${visibleMachines.map(machine => `
                                <th key="${machine.id}" class="min-w-[150px] w-[150px] text-xs font-bold text-slate-300 border-r border-slate-600 p-2">
                                    ${machine.name}
                                    <div class="flex border-t border-slate-600 mt-1">
                                        <div class="w-1/2 text-center text-[7px] font-black text-pink-400 border-r border-slate-700/50 tracking-wider">BALTA</div>
                                        <div class="w-1/2 text-center text-[7px] font-black text-indigo-400 tracking-wider">ANDRÉS</div>
                                    </div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${daysInMonth.map(day => {
                            const dateKey = getDateKey(day);
                            const dayOfWeek = day.toLocaleDateString('es-MX', { weekday: 'short' }).toUpperCase();
                            const isWeekend = dayOfWeek === 'SÁB' || dayOfWeek === 'DOM';
                            const rowClass = isWeekend ? 'bg-slate-800/50 hover:bg-slate-700/50' : 'hover:bg-slate-700';

                            return `
                                <tr class="text-sm border-t border-slate-700 ${rowClass}">
                                    <td class="w-20 text-center border-r border-slate-700 p-1 sticky-col font-bold">
                                        <span class="text-xl leading-none">${day.getDate()}</span>
                                        <span class="text-[10px] block text-slate-400">${dayOfWeek}</span>
                                    </td>
                                    ${visibleMachines.map(machine => renderCell(day, machine.id)).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('production-table-container').innerHTML = tableHTML;
        };

        const renderApp = () => {
            const appContainer = document.getElementById('app-container');
            if (!authReady || !visibilityConfig) {
                // Si aún no está listo, mostrar la pantalla de carga
                document.getElementById('loading-screen').classList.remove('hidden');
                return;
            }
            
            // Ocultar la pantalla de carga
            document.getElementById('loading-screen').classList.add('hidden');

            const isDev = USERS[userId]?.role === ROLES.DEVELOPMENT;

            appContainer.innerHTML = `
                <!-- Selector de Mes -->
                <div class="flex justify-center items-center gap-4 mb-6 p-3 bg-slate-800 rounded-xl border border-slate-700 shadow-xl">
                    <button id="prev-month" class="p-2 bg-indigo-600 rounded-full hover:bg-indigo-500 transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5 text-white"></i>
                    </button>
                    <h2 class="text-xl font-bold text-white w-40 text-center">
                        ${MONTH_NAMES_ES[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}
                    </h2>
                    <button id="next-month" class="p-2 bg-indigo-600 rounded-full hover:bg-indigo-500 transition-colors">
                        <i data-lucide="chevron-right" class="w-5 h-5 text-white"></i>
                    </button>
                </div>

                <!-- Header y Botones -->
                <header class="flex justify-between items-center bg-slate-800 p-4 rounded-xl mb-4 shadow-lg border border-slate-700">
                    <div class="flex flex-col">
                        <h1 class="text-3xl font-extrabold text-indigo-400">Monitor de Producción</h1>
                        <p class="text-sm text-slate-400 font-mono mt-1">
                            ${MONTH_NAMES_ES[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()} | Usuario: ${operatorName} (<span class="text-yellow-400">${userId}</span>)
                        </p>
                    </div>
                    <div class="flex gap-3 items-center">
                        ${isDev ? `
                            <button id="config-btn" class="bg-yellow-600 hover:bg-yellow-500 text-white text-sm font-bold px-4 py-2 rounded-xl transition-colors shadow-md flex items-center gap-2">
                                <i data-lucide="wrench" class="w-4 h-4"></i> Asignación (DEV)
                            </button>
                        ` : ''}
                        <button id="stats-btn" class="bg-sky-600 hover:bg-sky-500 text-white text-sm font-bold px-4 py-2 rounded-xl transition-colors shadow-md flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Comparativa Operadores
                        </button>
                    </div>
                </header>

                <!-- Tabla de Producción -->
                <div class="overflow-x-auto custom-scrollbar rounded-xl border border-slate-700 shadow-2xl" id="production-table-container">
                    <!-- Aquí se renderiza la tabla -->
                </div>
            `;
            
            // Crear iconos de Lucide
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Asignar Eventos
            document.getElementById('prev-month').onclick = () => changeMonth(-1);
            document.getElementById('next-month').onclick = () => changeMonth(1);
            document.getElementById('stats-btn').onclick = showStatsModal;
            if (isDev) {
                document.getElementById('config-btn').onclick = showVisibilityConfigModal;
            }

            // Renderizar la tabla con los datos actuales
            renderTable();
        };

        // =================================================================
        //                       MANEJO DE EVENTOS
        // =================================================================

        const changeMonth = (direction) => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + direction);
            // Esto forzará una nueva suscripción a los datos del mes
            setupDataSubscriptions(); 
            renderApp();
        };
        
        // =================================================================
        //                       EDITOR DE CELDAS
        // =================================================================

        const showCellEditor = (dateKey, machineId) => {
            const cellElement = document.getElementById(`cell-${dateKey}-${machineId}`);
            if (!cellElement) return;
            
            // Obtener datos existentes
            const dayData = monthData[dateKey] || {};
            const machineData = dayData[machineId] || {};
            const slots = machineData.slots || [];
            
            // Obtener configuración de slots
            const slotCount = visibilityConfig?.slots?.[machineId]?.count || 2;
            const inputValues = Array(4).fill(0).map((_, i) => slots[i]?.qty || '');
            const editableSlots = inputValues.map((_, index) => canEditSlot(userId, machineId, index, visibilityConfig));
            const canUserEditAnySlot = editableSlots.some(isEditable => isEditable);

            if (!canUserEditAnySlot) return; // Salir si no tiene permisos
            
            // Generar el modal/editor de la celda
            const modalContent = document.createElement('div');
            modalContent.className = "absolute inset-0 bg-slate-900/95 backdrop-blur-sm flex flex-col justify-center items-center z-10 p-2 border-2 border-yellow-500 rounded-lg shadow-xl fade-in";
            modalContent.id = "editor-modal";
            
            let inputsHTML = '';
            for (let i = 0; i < slotCount; i++) {
                const isDisabled = !editableSlots[i];
                inputsHTML += `
                    <input
                        type="text"
                        value="${inputValues[i]}"
                        placeholder="Slot ${i + 1}"
                        data-slot-index="${i}"
                        ${isDisabled ? 'disabled' : ''}
                        class="w-1/4 p-1 text-center text-xs rounded border ${!isDisabled ? 'bg-slate-700 text-white border-yellow-500 focus:ring-yellow-500' : 'bg-slate-800 text-slate-500 border-slate-700 cursor-not-allowed'}"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    />
                `;
            }

            modalContent.innerHTML = `
                <div class="flex gap-1 mb-2">
                    ${inputsHTML}
                </div>
                <div class="flex gap-1 text-xs">
                    <button id="save-cell-btn" class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded font-semibold transition-colors">Guardar</button>
                    <button id="cancel-cell-btn" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded font-semibold transition-colors">Cancelar</button>
                </div>
            `;
            
            cellElement.appendChild(modalContent);
            
            document.getElementById('save-cell-btn').onclick = () => saveCellChanges(dateKey, machineId, slotCount, cellElement);
            document.getElementById('cancel-cell-btn').onclick = () => modalContent.remove();
        };

        const saveCellChanges = async (dateKey, machineId, slotCount, cellElement) => {
            const editor = document.getElementById('editor-modal');
            if (!editor) return;

            const inputs = editor.querySelectorAll('input');
            const newSlots = [];
            const originalData = monthData[dateKey]?.[machineId] || {};
            
            inputs.forEach((input, index) => {
                const qty = Number(input.value) || 0;
                newSlots.push({
                    slot: index,
                    qty: qty,
                    date: new Date().toISOString()
                });
            });

            const newDayData = {
                dateKey: dateKey,
                calculated_target: Number(originalData.calculated_target || 0),
                product_type: originalData.product_type || 'N/A',
                slots: newSlots
            };

            const { doc, updateDoc, setDoc } = window.firebase;
            
            // 1. Intentar actualizar el documento
            try {
                const docRef = doc(db, getPrivateDocPath(userId), getMonthKey(currentMonthDate));
                await updateDoc(docRef, {
                    [`data.${machineId}`]: newDayData
                });
                console.log(`✅ Datos de ${machineId} para ${dateKey} guardados.`);

            } catch (error) {
                // 2. Si el documento del mes no existe, lo creamos con el setDoc
                if (error.code === 'not-found') {
                    const docRef = doc(db, getPrivateDocPath(userId), getMonthKey(currentMonthDate));
                    await setDoc(docRef, { 
                        dateKey: getMonthKey(currentMonthDate), 
                        data: { [machineId]: newDayData } 
                    }, { merge: true });
                    console.log(`✅ Documento de mes creado y datos de ${machineId} guardados.`);
                } else {
                    console.error("Error al guardar cambios:", error);
                }
            } finally {
                editor.remove();
                // onSnapshot se encargará de re-renderizar la tabla.
            }
        };

        // =================================================================
        //                       MODALES (Config y Stats)
        // =================================================================

        let chartInstance = null;

        const showStatsModal = () => {
            const modalRoot = document.getElementById('modal-root');
            
            const visibleMachines = (visibilityConfig?.machineOrder || MACHINE_CONFIG.map(m => m.id))
                .map(id => MACHINE_CONFIG.find(m => m.id === id)).filter(m => m);
            
            const monthTitle = `${MONTH_NAMES_ES[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
            
            modalRoot.innerHTML = getStatsModalHTML(monthTitle, visibleMachines);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Inicializar Listeners
            document.getElementById('close-stats-modal').onclick = () => modalRoot.innerHTML = '';
            document.getElementById('advanced-mode-toggle').onclick = () => {
                const isAdvanced = document.getElementById('advanced-mode-toggle').classList.toggle('is-advanced');
                renderChart(visibleMachines, isAdvanced);
                // Re-renderizar el modal para actualizar el estado del botón y la tarjeta
                showStatsModal(); 
            };
            document.getElementById('export-pdf').onclick = () => generatePDF(monthTitle, visibleMachines, document.getElementById('advanced-mode-toggle').classList.contains('is-advanced'));
            document.getElementById('export-excel').onclick = () => generateExcel(monthTitle, visibleMachines, document.getElementById('advanced-mode-toggle').classList.contains('is-advanced'));

            // Renderizar el gráfico
            renderChart(visibleMachines, false);
        };
        
        const calculateStats = (visibleMachines) => {
            const ID_ANDRES = '1392';
            const ID_BALTA = '7914';
            const dataRows = Object.values(monthData);

            return visibleMachines.map(m => {
                let andresTotal = 0;
                let baltaTotal = 0;
                let machineTargetTotal = 0;

                const mConfig = visibilityConfig?.slots?.[m.id] || {};
                const permissions = mConfig.permissions || {};

                dataRows.forEach(row => {
                    const mData = row[m.id] || {};
                    const slots = mData.slots || [];
                    const target = mData.calculated_target || 0;
                    machineTargetTotal += target;

                    slots.forEach((slot, index) => {
                        const qty = Number(slot?.qty) || 0;
                        if (qty === 0) return;

                        const assignedUserId = permissions[index];

                        if (assignedUserId === ID_ANDRES) {
                            andresTotal += qty;
                        } else if (assignedUserId === ID_BALTA) {
                            baltaTotal += qty;
                        } else {
                            // Fallback histórico
                            if (index <= 1) baltaTotal += qty; 
                            else andresTotal += qty;
                        }
                    });
                });

                const halfTarget = machineTargetTotal / 2;
                const andresEff = halfTarget > 0 ? (andresTotal / halfTarget) * 100 : 0;
                const baltaEff = halfTarget > 0 ? (baltaTotal / halfTarget) * 100 : 0;

                return {
                    name: m.name.replace('MAQ ', 'M-'),
                    fullName: m.name,
                    baltaQty: baltaTotal,
                    andresQty: andresTotal,
                    baltaEff: parseFloat(baltaEff.toFixed(1)),
                    andresEff: parseFloat(andresEff.toFixed(1)),
                    targetTotal: machineTargetTotal
                };
            });
        };

        const renderChart = (visibleMachines, isAdvanced) => {
            const machineStats = calculateStats(visibleMachines);
            const canvas = document.getElementById('stats-chart-canvas');
            if (!canvas || typeof Chart === 'undefined') return;

            if (chartInstance) chartInstance.destroy();

            const ctx = canvas.getContext('2d');
            
            const labels = machineStats.map(s => s.name);
            const datasetBalta = isAdvanced
                ? { label: 'Eficiencia Balta (%)', data: machineStats.map(s => s.baltaEff), backgroundColor: '#f472b6' } // Rosa
                : { label: 'Prod. Balta (Pzas)', data: machineStats.map(s => s.baltaQty), backgroundColor: '#ec4899' }; // Rosa fuerte
            
            const datasetAndres = isAdvanced 
                ? { label: 'Eficiencia Andrés (%)', data: machineStats.map(s => s.andresEff), backgroundColor: '#818cf8' } // Azul claro
                : { label: 'Prod. Andrés (Pzas)', data: machineStats.map(s => s.andresQty), backgroundColor: '#3b82f6' }; // Azul
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [datasetBalta, datasetAndres] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } },
                        title: { display: true, text: isAdvanced ? 'Rendimiento / Eficiencia (Meta Compartida)' : 'Producción Total (Piezas)', color: '#cbd5e1' }
                    },
                    scales: {
                        y: { 
                            grid: { color: '#1e293b' }, 
                            ticks: { color: '#64748b' }, 
                            beginAtZero: true,
                            title: { display: true, text: isAdvanced ? 'Porcentaje (%)' : 'Piezas', color: '#64748b' }
                        },
                        x: { grid: { display: false }, ticks: { color: '#64748b' } }
                    }
                }
            });
            
            // Actualizar tarjetas de detalle
            const detailContainer = document.getElementById('stats-details-container');
            if(detailContainer) {
                detailContainer.innerHTML = machineStats.map(s => {
                    const effBClass = s.baltaEff >= 90 ? 'text-green-400' : s.baltaEff >= 70 ? 'text-yellow-400' : 'text-red-400';
                    const effAClass = s.andresEff >= 90 ? 'text-green-400' : s.andresEff >= 70 ? 'text-yellow-400' : 'text-red-400';
                    
                    return `
                        <div class="bg-slate-700/30 p-3 rounded border border-slate-700 hover:bg-slate-700/50 transition-colors">
                            <p class="text-xs font-bold text-slate-300 mb-2 border-b border-slate-600 pb-1">${s.fullName}</p>
                            <div class="flex justify-between items-center text-sm mb-1">
                                <span class="text-pink-400 font-bold">Balta:</span>
                                <span class="text-slate-200">${s.baltaQty.toLocaleString()} <span class="text-[10px] text-slate-500">pzas</span></span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-blue-400 font-bold">Andrés:</span>
                                <span class="text-slate-200">${s.andresQty.toLocaleString()} <span class="text-[10px] text-slate-500">pzas</span></span>
                            </div>
                            <div class="mt-2 pt-2 border-t border-slate-600/50 flex gap-2 text-[10px] justify-between">
                                <span class="font-semibold ${effBClass}">Ef. Balta: ${s.baltaEff}%</span>
                                <span class="font-semibold ${effAClass}">Ef. Andrés: ${s.andresEff}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        const getStatsModalHTML = (title, visibleMachines) => {
            return `
                <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                    <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col border border-slate-700" onclick="event.stopPropagation()">
                        <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-white flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-indigo-400"></i> Comparativa Operadores</h3>
                                <p class="text-xs text-slate-500 uppercase font-bold">${title}</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="advanced-mode-toggle" class="px-3 py-2 rounded text-xs font-bold transition-colors bg-slate-700 text-slate-300 hover:bg-slate-600">
                                    Modo Básico
                                </button>
                                <div class="h-8 w-px bg-slate-700 mx-1"></div>
                                <button id="export-pdf" class="bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-2"><i data-lucide="file-down" class="w-4 h-4"></i> PDF</button>
                                <button id="export-excel" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-2"><i data-lucide="table" class="w-4 h-4"></i> Excel</button>
                                <button id="close-stats-modal" class="bg-slate-700 p-2 rounded hover:bg-slate-600 ml-2"><i data-lucide="x" class="text-white w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6 h-[400px]">
                                <canvas id="stats-chart-canvas"></canvas>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="stats-details-container">
                                <!-- Tarjetas de detalle -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const generatePDF = (title, visibleMachines, isAdvanced) => {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF no está cargado.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const machineStats = calculateStats(visibleMachines);

            doc.setFontSize(16);
            doc.text(`Reporte Comparativo - ${title}`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Modo: ${isAdvanced ? 'Avanzado (Eficiencia)' : 'Básico (Producción)'}`, 14, 28);
            doc.text(`Generado: ${new Date().toLocaleDateString()}`, 14, 34);

            const head = [['Máquina', 'Balta (Pzas)', 'Balta (%)', 'Andrés (Pzas)', 'Andrés (%)', 'Meta Global']];
            const body = machineStats.map(s => [
                s.fullName,
                s.baltaQty.toLocaleString(),
                s.baltaEff + '%',
                s.andresQty.toLocaleString(),
                s.andresEff + '%',
                s.targetTotal.toLocaleString()
            ]);

            doc.autoTable({
                startY: 40,
                head: head,
                body: body,
                theme: 'grid',
                headStyles: { fillColor: [30, 41, 59] },
                styles: { fontSize: 9 }
            });
            doc.save(`MAES26_Comparativo_${title}.pdf`);
        };

        const generateExcel = (title, visibleMachines, isAdvanced) => {
            if (typeof window.XLSX === 'undefined') {
                console.error("XLSX no está cargado.");
                return;
            }
            const machineStats = calculateStats(visibleMachines);

            const wsData = [
                ['Reporte de Producción', title],
                ['Generado', new Date().toLocaleString()],
                [],
                ['Máquina', 'Balta (Pzas)', 'Balta (Eficiencia %)', 'Andrés (Pzas)', 'Andrés (Eficiencia %)', 'Meta Total Máquina']
            ];

            machineStats.forEach(s => {
                wsData.push([
                    s.fullName,
                    s.baltaQty,
                    s.baltaEff / 100, // Exportar eficiencia como decimal para formato de Excel
                    s.andresQty,
                    s.andresEff / 100,
                    s.targetTotal
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, `MAES26_Reporte_${title.replace(' ', '_')}.xlsx`);
        };

        const showVisibilityConfigModal = async () => {
            const modalRoot = document.getElementById('modal-root');
            const isDev = USERS[userId]?.role === ROLES.DEVELOPMENT;
            
            if (!isDev) {
                 // Mensaje de denegación simplificado
                 modalRoot.innerHTML = `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 fade-in" onclick="document.getElementById('modal-root').innerHTML = ''">
                        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl text-red-400">
                            Acceso denegado. Solo el rol **Desarrollo** puede modificar esta configuración.
                        </div>
                    </div>
                 `;
                 setTimeout(() => modalRoot.innerHTML = '', 3000);
                 return;
            }

            // Cargar la configuración actual al abrir el modal (o usar la del estado global si ya está suscrita)
            let currentConfig = visibilityConfig;
            if (!currentConfig || Object.keys(currentConfig).length === 0) {
                const { doc, getDoc } = window.firebase;
                const docRef = doc(db, VISIBILITY_DOC_PATH);
                const docSnap = await getDoc(docRef);
                currentConfig = docSnap.exists() ? docSnap.data() : { machineOrder: MACHINE_CONFIG.map(m => m.id), slots: {} };
            }
            
            modalRoot.innerHTML = getVisibilityConfigModalHTML(currentConfig);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Inicializar Listeners y estado local del modal
            const configState = { ...currentConfig };
            let statusMessage = '';
            
            const renderModalContent = () => {
                modalRoot.innerHTML = getVisibilityConfigModalHTML(configState, statusMessage);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Reasignar eventos después de cada render
                document.getElementById('close-config-modal').onclick = () => modalRoot.innerHTML = '';
                document.getElementById('save-config-btn').onclick = saveConfigChanges;
                
                MACHINE_CONFIG.forEach(machine => {
                    const machineId = machine.id;
                    const slotCountElement = document.getElementById(`slots-count-${machineId}`);
                    if (slotCountElement) {
                        slotCountElement.onchange = (e) => handleSlotCountChange(machineId, e.target.value);
                    }
                    for (let i = 0; i < 4; i++) {
                        const slotSelect = document.getElementById(`slot-assign-${machineId}-${i}`);
                        if (slotSelect) {
                            slotSelect.onchange = (e) => handleSlotChange(machineId, i, e.target.value);
                        }
                    }
                });
            };
            
            const handleSlotChange = (machineId, slotIndex, operatorId) => {
                // Actualizar configState inmutablemente
                configState.slots = {
                    ...configState.slots,
                    [machineId]: {
                        ...(configState.slots[machineId] || {}),
                        permissions: {
                            ...(configState.slots[machineId]?.permissions || {}),
                            [slotIndex]: operatorId, 
                        }
                    }
                };
                // Forzar re-renderizado para reflejar el cambio (aunque en este modal no es estrictamente necesario visualmente)
                // console.log("Config updated locally:", configState);
            };

            const handleSlotCountChange = (machineId, count) => {
                const newCount = Number(count);
                configState.slots = {
                    ...configState.slots,
                    [machineId]: {
                        ...(configState.slots[machineId] || {}),
                        count: newCount
                    }
                };
                renderModalContent(); // Se necesita re-renderizar para mostrar/ocultar los selectores de slots.
            };

            const saveConfigChanges = async () => {
                document.getElementById('save-config-btn').disabled = true;
                statusMessage = 'Guardando...';
                renderModalContent();
                
                try {
                    const { doc, setDoc } = window.firebase;
                    await setDoc(doc(db, VISIBILITY_DOC_PATH), configState);
                    statusMessage = '✅ Configuración guardada con éxito.';
                    
                } catch (error) {
                    console.error("Error al guardar la configuración:", error);
                    statusMessage = '❌ Error al guardar. Consulta la consola.';
                } finally {
                    document.getElementById('save-config-btn').disabled = false;
                    renderModalContent();
                    // Cerrar después de éxito
                    if (statusMessage.startsWith('✅')) {
                        setTimeout(() => modalRoot.innerHTML = '', 1500);
                    }
                }
            };
            
            // Primer renderizado del modal
            renderModalContent();
        };

        const getVisibilityConfigModalHTML = (config, statusMessage = '') => {
            const availableOperators = Object.entries(USERS)
                .filter(([, user]) => user.role === ROLES.OPERATOR)
                .map(([id, user]) => ({ id, name: user.name }));

            const machineListHTML = MACHINE_CONFIG.map(machine => {
                const machineId = machine.id;
                const mConfig = config.slots?.[machineId] || {};
                const slotCount = mConfig.count || 2;
                const permissions = mConfig.permissions || {};

                const slotOptions = [];
                for (let i = 1; i <= 4; i++) slotOptions.push(i);

                const slotSelectors = [];
                for (let i = 0; i < slotCount; i++) {
                    slotSelectors.push(`
                        <div key="${i}" class="flex items-center gap-2 text-sm">
                            <span class="text-slate-300 font-bold">${i + 1}</span>
                            <select
                                id="slot-assign-${machineId}-${i}"
                                data-slot-index="${i}"
                                class="bg-slate-700 text-white p-1 rounded border border-slate-600 w-32"
                            >
                                <option value="">-- Sin Asignar --</option>
                                ${availableOperators.map(op => `
                                    <option value="${op.id}" ${permissions[i] === op.id ? 'selected' : ''}>${op.name}</option>
                                `).join('')}
                            </select>
                        </div>
                    `);
                }

                return `
                    <div key="${machineId}" class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-4 flex items-center justify-between">
                        <h4 class="text-lg font-semibold text-white w-32">${machine.name}</h4>
                        
                        <div class="flex items-center gap-4">
                            <label class="text-slate-400 text-sm flex items-center gap-2">
                                SLOTS:
                                <select
                                    id="slots-count-${machineId}"
                                    class="bg-slate-700 text-white p-1 rounded border border-slate-600"
                                >
                                    ${slotOptions.map(n => `<option value="${n}" ${n === slotCount ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </label>
                            
                            <div class="flex gap-2">
                                ${slotSelectors.join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in" onclick="document.getElementById('modal-root').innerHTML = ''">
                    <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col border border-slate-700" onclick="event.stopPropagation()">
                        <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-white flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-yellow-400"></i> Configuración de Máquinas (DEV)</h3>
                            <button id="close-config-modal" class="bg-slate-700 p-2 rounded hover:bg-slate-600"><i data-lucide="x" class="text-white w-4 h-4"></i></button>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                            ${machineListHTML}
                        </div>
                        <div class="p-4 bg-slate-900 border-t border-slate-700 flex justify-end items-center gap-4">
                            <p class="text-sm font-medium ${statusMessage.startsWith('✅') ? 'text-green-400' : 'text-red-400'}">${statusMessage}</p>
                            <button id="save-config-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl font-bold transition-colors disabled:opacity-50 flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // =================================================================
        //                       INICIO DE LA APP
        // =================================================================

        window.onload = setupFirebase;
    </script>
</body>
</html>

