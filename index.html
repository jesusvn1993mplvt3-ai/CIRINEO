<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITOR PLANTA - CIRINEO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #020617; color: white; overflow: hidden; }
        .neon-text { text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        /* Animación suave al aparecer reporte */
        .fade-enter { opacity: 0; transform: scale(0.95); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

        // CONFIGURACIÓN FIREBASE (La misma de tu app)
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const Icon = ({ name, size=24, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        // --- COMPONENTE TARJETA MÁQUINA (SOLO VISUAL) ---
        const MachineCard = ({ maquina, orders }) => {
            const pending = useMemo(() => {
                let list = [];
                orders.forEach(o => {
                    o.progreso.filter(p => !p.finished).forEach(p => list.push({
                        qty: p.cantidad, pieza: p.piezaNombre, partida: o.partida
                    }));
                });
                return list;
            }, [orders]);

            if (pending.length === 0) return null; // No mostrar si no hay trabajo

            return (
                <div className="bg-slate-900 border-2 border-slate-700 rounded-xl p-4 h-64 flex flex-col relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-2 opacity-10"><h1 className="text-8xl font-black">{maquina}</h1></div>
                    <div className="flex justify-between items-end border-b border-slate-700 pb-2 mb-2 z-10">
                        <div>
                            <span className="text-slate-400 text-xs font-bold uppercase tracking-widest">MÁQUINA</span>
                            <div className="text-5xl font-black text-yellow-400 neon-text">#{maquina}</div>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-bold text-white">{pending.length}</div>
                            <div className="text-[10px] text-slate-400 uppercase">Paquetes Pend.</div>
                        </div>
                    </div>
                    <div className="flex-grow overflow-y-auto space-y-2 z-10 pr-1">
                        {pending.map((p, i) => (
                            <div key={i} className="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700/50">
                                <span className="font-mono text-yellow-500 font-bold text-lg w-12 text-right">{p.qty}</span>
                                <span className="text-xs text-slate-300 truncate flex-1 mx-2">{p.pieza}</span>
                                <span className="text-[9px] bg-slate-800 px-1 rounded text-slate-500">{p.partida}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE REPORTE FLOTANTE ---
        const ReportOverlay = ({ maquina, orders }) => {
            // Lógica de cálculo (Igual que antes)
            const stats = useMemo(() => {
                const now = new Date();
                const d = new Date(now);
                const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
                const monday = new Date(d.setDate(diff)); monday.setHours(0,0,0,0);

                let produced = 0;
                let minutes = 0;
                const dailyData = [
                    {name:'Lun', p:0}, {name:'Mar', p:0}, {name:'Mie', p:0},
                    {name:'Jue', p:0}, {name:'Vie', p:0}, {name:'Sab', p:0}
                ];

                orders.filter(o => o.maquina === maquina).forEach(o => {
                    const time = Number(o.subPiecesData?.[0]?.tiempo) || 15;
                    o.progreso.forEach(p => {
                        if(p.finished && p.fecha) {
                            const pDate = new Date(p.fecha);
                            if(pDate >= monday) {
                                produced += p.cantidad;
                                minutes += (p.cantidad * time);
                                const dayIdx = pDate.getDay() - 1;
                                if(dayIdx >= 0 && dayIdx < 6) dailyData[dayIdx].p += p.cantidad;
                            }
                        }
                    });
                });
                
                // Eficiencia simple
                const minsAvailable = Math.max(1, Math.floor((now - monday)/60000));
                const efficiency = Math.min(100, ((minutes / minsAvailable) * 100)).toFixed(1);

                return { produced, efficiency, dailyData };
            }, [maquina, orders]);

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center fade-enter-active">
                    <div className="bg-slate-900 border-4 border-indigo-500 w-[90%] max-w-6xl p-8 rounded-3xl shadow-[0_0_50px_rgba(99,102,241,0.3)]">
                        <div className="grid grid-cols-12 gap-8 h-[60vh]">
                            <div className="col-span-4 flex flex-col justify-between">
                                <div>
                                    <h2 className="text-slate-400 text-xl font-bold uppercase tracking-widest">Reporte En Vivo</h2>
                                    <h1 className="text-8xl font-black text-white mb-2">MQ-{maquina}</h1>
                                    <div className="h-2 w-24 bg-indigo-500 mb-6"></div>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                    <div className="text-sm text-slate-400 font-bold uppercase mb-1">Eficiencia Semanal</div>
                                    <div className={`text-7xl font-mono font-black ${stats.efficiency >= 80 ? 'text-green-400' : 'text-orange-400'}`}>{stats.efficiency}%</div>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                    <div className="text-sm text-slate-400 font-bold uppercase mb-1">Piezas Producidas</div>
                                    <div className="text-6xl font-mono font-bold text-white">{stats.produced}</div>
                                </div>
                            </div>
                            <div className="col-span-8 bg-slate-800/50 rounded-2xl p-6 border border-slate-700">
                                <h3 className="text-center font-bold text-slate-400 mb-4">PRODUCCIÓN POR DÍA</h3>
                                <ResponsiveContainer width="100%" height="90%">
                                    <BarChart data={stats.dailyData}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false}/>
                                        <XAxis dataKey="name" stroke="#94a3b8" tick={{fill:'#94a3b8'}} axisLine={false} tickLine={false} />
                                        <YAxis stroke="#94a3b8" tick={{fill:'#94a3b8'}} axisLine={false} tickLine={false} />
                                        <Tooltip cursor={{fill: '#1e293b'}} contentStyle={{backgroundColor: '#0f172a', borderColor: '#334155', color: '#fff'}} />
                                        <Bar dataKey="p" fill="#6366f1" radius={[6, 6, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="mt-8 text-center animate-pulse">
                            <span className="text-slate-500 font-mono text-sm uppercase">Esperando comando del control remoto para cerrar...</span>
                        </div>
                    </div>
                </div>
            );
        };

        const MonitorApp = () => {
            const [orders, setOrders] = useState([]);
            const [remoteCommand, setRemoteCommand] = useState({ type: 'IDLE', target: null });
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                // 1. Escuchar Ordenes
                const u1 = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d=>d.data())));
                
                // 2. Escuchar Comandos del Control Remoto (Colección 'system', doc 'tv_control')
                const u2 = db.collection('system').doc('tv_control').onSnapshot(doc => {
                    if(doc.exists) setRemoteCommand(doc.data());
                });

                // 3. Reloj
                const timer = setInterval(() => setTime(new Date()), 1000);
                setTimeout(()=>lucide.createIcons(), 500);

                return () => { u1(); u2(); clearInterval(timer); };
            }, []);

            useEffect(()=>lucide.createIcons(), [orders, remoteCommand]);

            // Agrupar máquinas
            const machines = useMemo(() => {
                const mqs = new Set();
                orders.forEach(o => { 
                    // Solo mostrar máquinas activas (con órdenes no archivadas)
                    if(o.status !== 'ARCHIVADO' && o.progreso.some(p => !p.finished)) mqs.add(o.maquina); 
                });
                return Array.from(mqs).sort((a,b)=>a-b);
            }, [orders]);

            return (
                <div className="h-screen flex flex-col p-6 relative bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                        <div className="flex items-center gap-4">
                            <div className="p-3 bg-indigo-600 rounded-lg shadow-[0_0_20px_rgba(79,70,229,0.5)]">
                                <Icon name="monitor-play" className="text-white" size={32}/>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black tracking-tight text-white">SISTEMA VISUAL</h1>
                                <div className="text-xs text-indigo-400 font-bold uppercase tracking-widest">Monitor de Planta</div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-5xl font-mono font-black text-white leading-none">
                                {time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                            <div className="text-slate-500 font-bold uppercase text-sm mt-1">
                                {time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}
                            </div>
                        </div>
                    </div>

                    {/* Grid */}
                    <div className="grid grid-cols-4 xl:grid-cols-5 gap-6 flex-grow content-start overflow-hidden">
                        {machines.map(m => (
                            <MachineCard key={m} maquina={m} orders={orders} />
                        ))}
                        {machines.length === 0 && (
                            <div className="col-span-full h-full flex flex-col items-center justify-center text-slate-700">
                                <Icon name="check-circle" size={120} className="mb-6 opacity-20"/>
                                <h2 className="text-4xl font-bold opacity-50">SIN PENDIENTES</h2>
                            </div>
                        )}
                    </div>

                    {/* Modal controlado remotamente */}
                    {remoteCommand.type === 'SHOW_REPORT' && (
                        <ReportOverlay maquina={remoteCommand.target} orders={orders} />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonitorApp />);
    </script>
</body>
</html>
